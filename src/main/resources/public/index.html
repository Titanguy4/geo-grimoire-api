<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoGrimoire - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- Header -->
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">üó∫Ô∏è GeoGrimoire</h1>
        <p class="text-gray-600">
          Gestion des indices g√©ographiques pour GeoGuessr
        </p>
      </header>

      <!-- Formulaire d'ajout -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Ajouter un indice</h2>
        <form id="addForm" class="grid grid-cols-1 gap-4">
          <!-- Pays -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Pays</label
            >
            <input
              type="text"
              id="country"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Ex: Japon"
            />
          </div>

          <!-- R√©gion -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >R√©gion</label
            >
            <input
              type="text"
              id="region"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Ex: Asie de l'Est"
            />
          </div>

          <!-- Cat√©gorie -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Cat√©gorie</label
            >
            <select
              id="category"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">S√©lectionner...</option>
              <option value="Langue">Langue</option>
              <option value="Conduite">Conduite</option>
              <option value="Drapeau">Drapeau</option>
              <option value="Infra">Infra</option>
              <option value="Meta">Meta</option>
            </select>
          </div>

          <!-- Contenu -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Contenu</label
            >
            <textarea
              id="content"
              required
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Description d√©taill√©e..."
            ></textarea>
          </div>

          <!-- Keywords -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Mots-cl√©s (s√©par√©s par des virgules)</label
            >
            <input
              type="text"
              id="keywords"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Ex: gauche, left-hand, volant"
            />
          </div>

          <button
            type="submit"
            class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium transition"
          >
            Ajouter l'indice
          </button>
        </form>

        <!-- Message -->
        <div id="message" class="mt-4 hidden"></div>
      </div>

      <!-- Liste des indices -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-4">
          üìç Liste des indices
          <button
            onclick="loadIndices()"
            class="ml-2 text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200 text-sm transition"
          >
            üîÑ Rafra√Æchir
          </button>
        </h2>

        <div id="loading" class="text-center py-8">
          <div
            class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
          ></div>
          <p class="mt-2 text-gray-600">Chargement...</p>
        </div>

        <div id="indicesList" class="hidden">
          <div id="count" class="text-sm text-gray-600 mb-4"></div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-100">
                <tr>
                  <th
                    class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase"
                  >
                    Pays
                  </th>
                  <th
                    class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase"
                  >
                    R√©gion
                  </th>
                  <th
                    class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase"
                  >
                    Cat√©gorie
                  </th>
                  <th
                    class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase"
                  >
                    Contenu
                  </th>
                  <th
                    class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase"
                  >
                    Mots-cl√©s
                  </th>
                </tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Charger les indices au d√©marrage
      loadIndices();

      // Gestion du formulaire
      document
        .getElementById("addForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const indice = {
            country: document.getElementById("country").value,
            region: document.getElementById("region").value,
            category: document.getElementById("category").value,
            content: document.getElementById("content").value,
            keywords: document
              .getElementById("keywords")
              .value.split(",")
              .map((k) => k.trim()),
          };

          try {
            const response = await fetch("/indices", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(indice),
            });

            const message = document.getElementById("message");

            if (response.ok) {
              message.className =
                "mt-4 p-3 bg-green-100 text-green-700 rounded-md";
              message.textContent = "‚úÖ Indice ajout√© avec succ√®s !";
              message.classList.remove("hidden");

              // R√©initialiser le formulaire
              document.getElementById("addForm").reset();

              // Recharger la liste
              setTimeout(() => {
                loadIndices();
                message.classList.add("hidden");
              }, 2000);
            } else {
              const errorText = await response.text();
              message.className = "mt-4 p-3 bg-red-100 text-red-700 rounded-md";
              message.textContent = "‚ùå Erreur r√©seau : " + errorText;
              message.classList.remove("hidden");
            }
          } catch (error) {
            const message = document.getElementById("message");
            message.className = "mt-4 p-3 bg-red-100 text-red-700 rounded-md";
            message.textContent = "‚ùå Erreur r√©seau : " + error.message;
            message.classList.remove("hidden");
          }
        });

      // Charger les indices
      async function loadIndices() {
        const loading = document.getElementById("loading");
        const list = document.getElementById("indicesList");

        loading.classList.remove("hidden");
        list.classList.add("hidden");

        try {
          const response = await fetch("/indices");
          const indices = await response.json();

          document.getElementById(
            "count"
          ).textContent = `Total : ${indices.length} indice(s)`;

          const tbody = document.getElementById("tableBody");
          tbody.innerHTML = indices
            .map(
              (indice) => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${escapeHtml(
                          indice.country
                        )}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${escapeHtml(
                          indice.region
                        )}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getCategoryColor(
                              indice.category
                            )}">
                                ${escapeHtml(indice.category)}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700 max-w-md">${escapeHtml(
                          indice.content
                        )}</td>
                        <td class="px-4 py-3 text-sm">
                            ${indice.keywords
                              .map(
                                (k) => `
                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">
                                    ${escapeHtml(k)}
                                </span>
                            `
                              )
                              .join("")}
                        </td>
                    </tr>
                `
            )
            .join("");

          loading.classList.add("hidden");
          list.classList.remove("hidden");
        } catch (error) {
          loading.innerHTML = `
                    <div class="text-red-600">
                        <p class="font-medium">‚ùå Erreur de chargement</p>
                        <p class="text-sm mt-1">${error.message}</p>
                    </div>
                `;
        }
      }

      function getCategoryColor(category) {
        const colors = {
          Langue: "bg-purple-100 text-purple-800",
          Conduite: "bg-green-100 text-green-800",
          Drapeau: "bg-red-100 text-red-800",
          Infra: "bg-yellow-100 text-yellow-800",
          Meta: "bg-blue-100 text-blue-800",
        };
        return colors[category] || "bg-gray-100 text-gray-800";
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
